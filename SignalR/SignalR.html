<!DOCTYPE html><html><head><title>SignalR</title><meta charset='utf-8'><link href='https://dn-maxiang.qbox.me/res-min/themes/marxico.css' rel='stylesheet'><style></style></head><body><div id='preview-contents' class='note-content'>
                        <div id="wmd-preview" class="preview-content"></div>
                    <div id="wmd-preview-section-1" class="wmd-preview-section preview-content">

</div><div id="wmd-preview-section-2" class="wmd-preview-section preview-content">

<h1 id="signalr">SignalR</h1>

<p><strong>关于SignalR的dome可以在微软的官方<a href="https://code.msdn.microsoft.com/SignalR-3ec71545" target="_blank">下载</a>,但是官方上提供的代码是web应用程序与web应用程序之间的交互，还有桌面应用程序与桌面应用程序之间的交互。所以，我通过修改dome，做了一个web应用程序与桌面应用程序之间交互的dome。</strong></p>

</div><div id="wmd-preview-section-3" class="wmd-preview-section preview-content">

<h2 id="web应用程序">Web应用程序</h2>

<p><strong>首先创建一个web应用程序（基于MVC），那么这个应用程序就要充当服务器和客户端。创建好了之后再做如下步骤：</strong> <br>
  1.引入SignalR包，在NuGet的控制台输入 install-package Microsoft.AspNet.SignalR</p>

<p>2.使用ServerHub这个类来作为服务器。（微软dome中的类，ServerHub.cs）</p>

<p>3.在HomeController下添加一个控件</p>

<pre class="prettyprint hljs-dark"><code class="hljs aspectj">  <span class="hljs-keyword">public</span> <span class="hljs-function">ActionResult <span class="hljs-title">Chat</span><span class="hljs-params">()</span><br>    </span>{<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">View</span><span class="hljs-params">()</span></span>;<br>    }<br></code></pre>

<p>这个控件是用来提供给web客户端使用的。 <br>
再生成Chat控件的视图：</p>

<pre class="prettyprint hljs-dark"><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"container"</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"message"</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"button"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"sendmessage"</span> <span class="hljs-attribute">value</span>=<span class="hljs-value">"发送"</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"hidden"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"displayname"</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-title">ul</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"discussion"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">ul</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span><br>   @section scripts<br>           {<br><span class="hljs-comment">&lt;!--引用SignalR库. --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"~/Scripts/jquery.signalR-2.2.0.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-comment">&lt;!--引用自动生成的SignalR 集线器(Hub)脚本.在运行的时候在浏览器的Source下可看到 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"~/signalr/hubs"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript"><br>    $(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{<br>        <span class="hljs-comment">// 引用自动生成的集线器代理</span><br>        <span class="hljs-keyword">var</span> chat = $.connection.serverHub;<br>        <span class="hljs-comment">// 定义服务器端调用的客户端sendMessage来显示新消息</span><br><br>        chat.client.sendMessage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name, message</span>) </span>{<br>            <span class="hljs-comment">// 向页面添加消息</span><br>            $(<span class="hljs-string">'#discussion'</span>).append(<span class="hljs-string">'&lt;li&gt;&lt;strong&gt;'</span> + htmlEncode(name)<br>                + <span class="hljs-string">'&lt;/strong&gt;: '</span> + htmlEncode(message) + <span class="hljs-string">'&lt;/li&gt;'</span>);<br>        };<br><br>        <span class="hljs-comment">// 设置焦点到输入框</span><br>        $(<span class="hljs-string">'#message'</span>).focus();<br>        <span class="hljs-comment">// 开始连接服务器</span><br>        $.connection.hub.start().done(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{<br>            $(<span class="hljs-string">'#sendmessage'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{<br>                <span class="hljs-comment">// 调用服务器端集线器的Send方法</span><br>                chat.server.send($(<span class="hljs-string">'#message'</span>).val());<br>                <span class="hljs-comment">// 清空输入框信息并获取焦点</span><br>                $(<span class="hljs-string">'#message'</span>).val(<span class="hljs-string">''</span>).focus();<br>            });<br>        });<br>    });<br><br>    <span class="hljs-comment">// 为显示的消息进行Html编码</span><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">htmlEncode</span>(<span class="hljs-params">value</span>) </span>{<br>        <span class="hljs-keyword">var</span> encodedValue = $(<span class="hljs-string">'&lt;div /&gt;'</span>).text(value).html();<br>        <span class="hljs-keyword">return</span> encodedValue;<br>    }<br><br></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span><br>  }<br></code></pre>

<p>4.在Startup中添加</p>

<pre class="prettyprint hljs-dark"><code class="hljs stata"> <span class="hljs-comment">// 配置集线器</span><br> <span class="hljs-keyword">app</span>.MapSignalR();<br></code></pre>

<p>通过上面的代码就做好了web端的交互。</p>

</div><div id="wmd-preview-section-14" class="wmd-preview-section preview-content">

<h2 id="桌面应用程序">桌面应用程序</h2>

<p><strong>同样桌面应用程序也要引用SignalR包。</strong> <br>
1.引入SignalR包，在NuGet的控制台输入 install-package Microsoft.AspNet.SignalR和install-package Microsoft.AspNet.SignalR.Client</p>

<p>2.初始化集线器代理对象</p>

<pre class="prettyprint hljs-dark"><code class="hljs cs">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConnectAsync</span>(<span class="hljs-params"></span>)<br>    </span>{<br>        <span class="hljs-keyword">try</span><br>        {<br>            Connection = <span class="hljs-keyword">new</span> HubConnection(ServerUri);<span class="hljs-comment">//初始化连接服务器对象</span><br>            Connection.Closed += Connection_Closed;<span class="hljs-comment">//程序关闭时发生</span><br><br>            <span class="hljs-comment">// 创建一个集线器代理对象</span><br>            HubProxy = Connection.CreateHubProxy(<span class="hljs-string">"ServerHub"</span>);<br><br>            <span class="hljs-comment">// 供服务端调用，将消息输出到消息列表框中</span><br>            HubProxy.On&lt;<span class="hljs-keyword">string</span>, <span class="hljs-keyword">string</span>&gt;(<span class="hljs-string">"sendMessage"</span>, (name, message) =&gt;<br>                 <span class="hljs-keyword">this</span>.Dispatcher.Invoke(() =&gt;<br>                    RichTextBoxConsole.AppendText(String.Format(<span class="hljs-string">"{0}: {1}\r"</span>, name, message))<br>                ));<br>            <span class="hljs-keyword">try</span><br>            {<br>                <span class="hljs-keyword">await</span> Connection.Start();<span class="hljs-comment">//测试与服务器的连接</span><br>            }<br>            <span class="hljs-keyword">catch</span> (HttpRequestException)<br>            {<br>                ChatPanel.Visibility = Visibility.Visible;<br>                RichTextBoxConsole.AppendText(<span class="hljs-string">"请检查服务是否开启："</span> + ServerUri + <span class="hljs-string">"\r"</span>);<br>                <span class="hljs-comment">// 连接失败</span><br>                <span class="hljs-keyword">return</span>;<br>            }<br><br>            <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span>/ 显示聊天控件</span><br>            ChatPanel.Visibility = Visibility.Visible;<br>            ButtonSend.IsEnabled = <span class="hljs-keyword">true</span>;<br>            Buttonimge.IsEnabled = <span class="hljs-keyword">true</span>;<br>            TextBoxMessage.Focus();<br>            RichTextBoxConsole.AppendText(<span class="hljs-string">"连上服务："</span> + ServerUri + <span class="hljs-string">"\r"</span>);<br>        }<br>        <span class="hljs-keyword">catch</span> (Exception ew)<br>        {<br>            MessageBox.Show(ew.ToString());<br>        }<br>    }<br></code></pre>

<p>3.定义发送按钮</p>

<pre class="prettyprint hljs-dark"><code class="hljs cs">    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 发送消息</span><br>    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="sender"&gt;</span><span class="hljs-xmlDocTag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="e"&gt;</span><span class="hljs-xmlDocTag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ButtonSend_Click</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, RoutedEventArgs e</span>)<br>    </span>{<br>        <span class="hljs-comment">// 通过代理来调用服务端的Send方法</span><br>        <span class="hljs-comment">// 服务端Send方法再调用客户端的AddMessage方法将消息输出到消息框中</span><br>        HubProxy.Invoke(<span class="hljs-string">"Send"</span>, TextBoxMessage.Text.Trim());<br><br>        TextBoxMessage.Text = String.Empty;<br>        TextBoxMessage.Focus();<br>    }<br></code></pre></div><div id="wmd-preview-section-5" class="wmd-preview-section preview-content">

<h3 id="桌面应用程序作为服务器">桌面应用程序作为服务器</h3>

<p><strong>如果要使用桌面应用程序作为服务器那么就要在项目下创建一个Startup类</strong></p>

<pre class="prettyprint hljs-dark"><code class="hljs cs"><span class="hljs-keyword">using</span> Microsoft.Owin;<br><span class="hljs-keyword">using</span> Owin;<br><br>[assembly: OwinStartup(<span class="hljs-keyword">typeof</span>(SignalWPFHost.Startup))]<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">SignalWPFHost</span><br> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span><br>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configuration</span>(<span class="hljs-params">IAppBuilder app</span>)<br>    </span>{<br>        <span class="hljs-comment">// 有关如何配置应用程序的详细信息，请访问 http://go.microsoft.com/fwlink/?LinkID=316888</span><br>        <span class="hljs-comment">// 允许CORS跨域</span><br>        <span class="hljs-comment">//app.UseCors(CorsOptions.AllowAll);</span><br>        app.MapSignalR();<br>    }<br>}<br>}<br></code></pre>

<p>2.启动SignalR服务，这需要一个web应用程序来启动，所以需要Startup.cs。</p>

<pre class="prettyprint hljs-dark"><code class="hljs cs">    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> 启动SignalR服务，将SignalR服务寄宿在WPF程序中</span><br>    <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">StartServer</span>(<span class="hljs-params"></span>)<br>    </span>{<br>        <span class="hljs-keyword">try</span><br>        {<br>            SignalR = WebApp.Start(ServerUri);  <span class="hljs-comment">// 启动SignalR服务</span><br>        }<br>        <span class="hljs-keyword">catch</span> (TargetInvocationException)<br>        {<br>            WriteToConsole(<span class="hljs-string">"一个服务已经运行在："</span> + ServerUri);<br>            <span class="hljs-comment">// Dispatcher回调来设置UI控件状态</span><br>            <span class="hljs-keyword">this</span>.Dispatcher.Invoke(() =&gt; ButtonStart.IsEnabled = <span class="hljs-keyword">true</span>);<br>            <span class="hljs-keyword">return</span>;<br>        }<br><br>        <span class="hljs-keyword">this</span>.Dispatcher.Invoke(() =&gt; ButtonStop.IsEnabled = <span class="hljs-keyword">true</span>);<br>        WriteToConsole(<span class="hljs-string">"服务已经成功启动，地址为："</span> + ServerUri);<br>    }<br></code></pre>

<p>3.继承Hub类，这个类将作为一个服务，允许客户端远程调用</p>

<pre class="prettyprint hljs-dark"><code class="hljs cs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ChatHub</span> : <span class="hljs-title">Hub</span><br>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Send</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> name, <span class="hljs-keyword">string</span> message</span>)<br>    </span>{<br>        Clients.All.addMessage(name, message);<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">OnConnected</span>(<span class="hljs-params"></span>)<br>    </span>{<br>        <span class="hljs-comment">//</span><br>        Application.Current.Dispatcher.Invoke(() =&gt;<br>            ((MainWindow)Application.Current.MainWindow).WriteToConsole(<span class="hljs-string">"客户端连接，连接ID是: "</span> + Context.ConnectionId));<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.OnConnected();<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">OnDisconnected</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span> stopCalled</span>)<br>    </span>{<br>         Application.Current.Dispatcher.Invoke(() =&gt;<br>            ((MainWindow)Application.Current.MainWindow).WriteToConsole(<span class="hljs-string">"客户端断开连接，连接ID是: "</span> + Context.ConnectionId));<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.OnDisconnected(<span class="hljs-keyword">true</span>);<br>    }<br>}<br></code></pre></div><div id="wmd-preview-section-footnotes" class="preview-content"></div></div></body></html>